<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
		crossorigin="anonymous"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
		crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
</head>

<body>

	<!--Tabela-->
	<table class="table table-hover table-responsive"> 
		<thead>
			<tr style="text-align: center">
				<th scope="col">Central</th>
				<th scope="col">Contrato</th>
				<th scope="col">Situação</th>
				<th scope="col">Tipo Bomba</th>
				<th scope="col">Tipo Aplicação</th>
				<th scope="col">Traço Selecionado</th>
				<th scope="col">Qtd. Solicitada</th>
				<th scope="col">Qtd. em Aberto</th>
				<th scope="col">Resp. Obra</th>
				<th scope="col">Contato Resp. Obra</th>
				<th scope="col">Data Programação</th>
				<th scope="col">Observação</th>
				<th scope="col"></th>
			</tr>
		</thead>
		<tbody id="tbodyProgs" >
		</tbody>
	</table>

	<!--Modal Aprovação-->
	<form id="formAprovacao">
		<div class="modal fade" id="modalConfirmacao" tabindex="-1" role="dialog" aria-labelledby="modalConfirmacaoLabel" data-backdrop="static">
		<div class="modal-dialog" role="document">
		  <div class="modal-content">
			<div class="modal-header">
			  <h4 class="modal-title" id="modalConfirmacaoLabel">Aprovar Programação</h4>
			</div>
			<div class="modal-body">
			  <div class="form-group">
				<label for="input2">Data da Confirmação</label>
				<input type="date" class="form-control" id="input2" required>
				<label for="input3">Número Programação no Command </label>
				<input type="number" class="form-control" id="input3" required>
			  </div>
			</div>
			<div class="modal-footer">
			  <button id="cancelarBtn" type="button" class="btn btn-secondary">Cancelar</button>
			  <button id="confirmarBtn" type="submit" class="btn btn-primary" >Confirmar</button>
			</div>
		  </div>
		</div>
		</div>
	</form>

	<!--Modal Reprovação-->
	<form id="formReprovacao">
		<div class="modal fade" id="modalReprovacao" tabindex="-1" role="dialog" aria-labelledby="modalReprovacaoLabel" data-backdrop="static">
			<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
				<h4 class="modal-title" id="modalReprovacaoLabel">Reprovar Programação</h4>
				</div>
				<div class="modal-footer">
				<button id="cancelarBtnRep" type="button" class="btn btn-secondary">Cancelar</button>
				<button id="reprovarBtn" type="button" class="btn btn-primary" >Confirmar</button>
				</div>
			</div>
			</div>
		</div>
    </form>

	<!--Modal Loading-->
	<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" style="display: none;">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-body text-center">
					<span style="font-weight: 400;font-size: 17px;">Carregando, por favor, aguarde...</span>
					<br><img src="images/loader/ajax-loader-red.gif" style="width: 100px;">
				</div>			
	    	</div>
	  	</div>
	</div>
</body>


<script>
	var programacoesSol = "";
	var objTratado;
	var programacaoSel;
	var listaIdSel;
	var idxSel;

	window.onload = function montaTable() {

		var parametros = {
			idCvtccnpj: parent.dadosUserLogadoPersonalizado().cId,
			numreg: 751,
			pRotina: "lerProgramacao",
			pCodCli: parent.dadosUserLogadoPersonalizado().rCod
		};
    
		 $.ajax({
			url: parent.dadosUserLogadoPersonalizado().cContextIntegracao + '/rest/Listas/executarRequisicaoExterna',
			type: "POST",
			data: JSON.stringify(parametros),
			success: function (response) {

				$("#loadingModal").modal('hide');

				var objRetorno = JSON.parse(response);
				
				objRetorno.map(({central, contrato, tipoBomba, tipoAplicacao, tracoSel, qtdSolicitada, qtdAberto, respObra, contatoRespObra, observacao, dataProgramacaoSel, listaId, situacao },idx) => {
					
					if(tipoBomba.includes("Ã§") || tipoBomba.includes("A¡") || tipoBomba.includes("Ã¡")){
						tipoBomba = tipoBomba.replace('Ã§', 'ç');
						tipoBomba = tipoBomba.replace('A¡', 'á');
						tipoBomba = tipoBomba.replace('Ã¡', 'á');
					} 

					if(tipoAplicacao.includes("Ã©") || tipoAplicacao.includes("A©")){
						tipoAplicacao = tipoAplicacao.replace('Ã©', 'é');
						tipoAplicacao = tipoAplicacao.replace('A©', 'é');
					} 

					if(respObra.includes("Ã¡") || respObra.includes("Ãª") || respObra.includes("Ã£") ||  respObra.includes("Ã¢") || respObra.includes("Ã´") ){
						respObra = respObra.replace("Ã¡", "á");
						respObra = respObra.replace("Ã£", "ã");
						respObra = respObra.replace("Ãª", "ê");
						respObra = respObra.replace("Ã¢", "â");
						respObra = respObra.replace("Ã´", "ô");
					}

					if(observacao.includes("Ã¡") || observacao.includes("Ãª") || observacao.includes("Ã£") || observacao.includes("Ã©") || observacao.includes("A©") || observacao.includes("Ã§") || observacao.includes("Ã???????") || observacao.includes("Ã³") 
					|| observacao.includes("Ã°")  ){
						observacao = observacao.replace("Ã¡", "á");
						observacao = observacao.replace("Ã£", "ã");
						observacao = observacao.replace("Ãª", "ê");
						observacao = observacao.replace('Ã©', 'é');
						observacao = observacao.replace('A©', 'é');
						observacao = observacao.replace('Ã§', 'ç');
						observacao = observacao.replace('Ã?', 'í');
						observacao = observacao.replace('Ã³', 'ó');
						observacao = observacao.replace('Ãº', 'ú');
					}
					programacaoSel = objRetorno;
					var data =  dataProgramacaoSel;
					var dataFormatada = data.split("-").reverse().join('-');
					let sit;

					if(situacao == "R"){
						sit = "Reprovado"
						programacoesSol += ` <tr id="linhaTr-${idx}" name="tbodyProgs" style="vertical-align: middle; text-align: center;">
									  <th scope="row">${central}</th>
									  <td>${contrato}</td>
									  <td>${sit}</td> 
									  <td>${tipoBomba}</td>
									  <td>${tipoAplicacao}</td>
									  <td>${tracoSel}</td>
									  <td>${qtdSolicitada}</td>
									  <td>${qtdAberto}</td>
									  <td>${respObra}</td>
									  <td>${contatoRespObra}</td>
									  <td>${dataFormatada}</td>
									  <td>${observacao}</td>
									  <td style="font-size: 20px">
									  </td>
									</tr>`;
					 }
				     else if (situacao == "S"){
						sit = "Solicitado"
						programacoesSol += ` <tr id="linhaTr-${idx}" name="tbodyProgs" style="vertical-align: middle; text-align: center;">
									  <th scope="row">${central}</th>
									  <td>${contrato}</td>
									  <td>${sit}</td> 
									  <td>${tipoBomba}</td>
									  <td>${tipoAplicacao}</td>
									  <td>${tracoSel}</td>
									  <td>${qtdSolicitada}</td>
									  <td>${qtdAberto}</td>
									  <td>${respObra}</td>
									  <td>${contatoRespObra}</td>
									  <td>${dataFormatada}</td>
									  <td>${observacao}</td>
									  <td style="font-size: 20px">
										<span type="button"><i class="bi bi-check-square-fill" style="color: limegreen" onclick="abrirModalConfirmacao(${listaId}, ${idx})" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Confirmar ProgramaÃ§Ã£o"></i></span>
										<span type="button"><i class="bi bi-x-square-fill" style="color: red" onclick="abrirModalReprovacao(${listaId},${idx})"></i></span>
									  </td>
									</tr>`;
					 }
				     else if (situacao == "A"){
						sit = "Aprovado"
					 }
					
				});
				document.getElementById("tbodyProgs").innerHTML = programacoesSol; 
				
			},
			beforeSend: function () {
				$("#loadingModal").modal('show');
			},
			complete: function () {
				$("#loadingModal").modal('hide');
			},
			error: function (response) {
				alert(response);
			}
		}); 
	};
	
	function reprovarProg(id, idx){
		
		var parametros = {
			idCvtccnpj: parent.dadosUserLogadoPersonalizado().cId,
			numreg: 751,
			pRotina: "reprovarProgramacao",
			pIdLog : id
		};
		
		$.ajax({
			url: parent.dadosUserLogadoPersonalizado().cContextIntegracao + '/rest/Listas/executarRequisicaoExterna',
			type: "POST",
			data: JSON.stringify(parametros),
			success: function (response) {
				document.getElementById(`linhaTr-${idx}`).remove();
				$("#modalReprovacao").modal('hide');
				
			},
			beforeSend: function () {
				$("#loadingModal").modal('show');
			},
			complete: function () {
				$("#loadingModal").modal('hide');
				$("#modalReprovacao").modal('hide');
			},
			error: function (response) {
				alert(response);
			}
		});	
	};
	
	function aprovarProg(id, idx, json){

		json = json.filter(({listaId}) => listaId == id )[0];


		var pJson = {
			"central": json.central,
			"contatoRespObra": json.contatoRespObra,
			"contrato": json.contrato,
			"dataProgramacaoSel": json.dataProgramacaoSel, 
			"endereco": json.endereco,
			"observacao": json.observacao,
			"qtdAberto": json.qtdAberto,
			"qtdSolicitada": json.qtdSolicitada,
			"respObra": json.respObra,
			"tipoAplicacao": json.tipoAplicacao,
			"tipoBomba": json.tipoBomba,
			"tracoSel": json.tracoSel,
			"tracoSelDes": json.tracoSelDes,
			"dataProgramacaoEfetiva": document.getElementById("input2").value.split('-').reverse().join('/'),
			"numeroProgCommand": document.getElementById('input3').value
		}
		
		var parametros = {
			idCvtccnpj: parent.dadosUserLogadoPersonalizado().cId,
			numreg: 751,
			pRotina: "aprovarProgramacao", 
			pIdLog : id,
			pJson: pJson
		};
		
		$.ajax({
			url: parent.dadosUserLogadoPersonalizado().cContextIntegracao + '/rest/Listas/executarRequisicaoExterna',
			type: "POST",
			data: JSON.stringify(parametros),
			success: function (response) {
				document.getElementById(`linhaTr-${idx}`).remove();
				$("#modalConfirmacao").modal('hide');
			},
			beforeSend: function () {
				$("#loadingModal").modal('show');
			},
			complete: function () {
				$("#loadingModal").modal('hide');
				$("#modalConfirmacao").modal('hide');
			},
			error: function (response) {
				alert(response);
			}
		});	
	
	};

	function abrirModalConfirmacao(listaId, idx){

		console.log(programacaoSel);

		listaIdSel = listaId;
		idxSel = idx;
		$("#modalConfirmacao").modal('show');
	}

	$("#confirmarBtn").click(function () {

		var formulario = document.getElementById("formAprovacao");
        if (!formulario.checkValidity()) {
        } else {
			aprovarProg(listaIdSel,idxSel, programacaoSel);
        }
    });

	function abrirModalReprovacao(listaId, idx){

		listaIdSel = listaId;
		idxSel = idx;
		$("#modalReprovacao").modal('show');
	}

	$("#reprovarBtn").click(function () {
		reprovarProg(listaIdSel,idxSel);
    });

	$("#cancelarBtn").click(function () {
		$("#modalConfirmacao").modal('hide');
    });

	$("#cancelarBtnRep").click(function () {
		$("#modalReprovacao").modal('hide');
    });
	
	
       
</script>

</html>